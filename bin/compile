#!/usr/bin/env bash
set -o errexit
set -o nounset

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2
NODE_VER="4.2.3"
PATH_SH=$BUILD_DIR/.profile.d/path.sh
URL="https://nodejs.org/dist/v$NODE_VER/node-v$NODE_VER-linux-x64.tar.gz"

echo "! Be sure to set the PSSST_KEY config var" | indent

env
echo $ENV

# Create directories
mkdir -p $BUILD_DIR/.profile.d/
mkdir -p $BUILD_DIR/vendor

# Download binary
echo "-----> Installing node@$NODE_VER"
curl $URL -s -o - | tar xzf - -C $BUILD_DIR/vendor/

# Export path
export PATH=$PATH:"$BUILD_DIR/vendor/node-v$NODE_VER-linux-x64/bin"
echo "PATH=$PATH:$HOME/vendor/node-v$NODE_VER-linux-x64/bin" > $PATH_SH

# Install packages
echo "-----> Installing npm packages"
cd $BUILD_DIR/src/server/
npm install | indent
